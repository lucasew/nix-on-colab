#!/usr/bin/env bash

# Busca da pasta atual onde o script foi clonado
CURRENT_DIR=`cd "$(dirname "$0")"; pwd`

# Liberação de permissão no /content
chmod 777 /content

# Criação do usuário não root e autorização para sudo
useradd -d /content -g users colab
echo 'colab ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Instalação dos scripts utilitários
install -m755 "$CURRENT_DIR/deroot_in" /bin
install -m755 "$CURRENT_DIR/deroot_out" /bin
install -m755 "$CURRENT_DIR/deroot" /bin

# Instalação do nix em modo multiuser
curl -L https://nixos.org/nix/install > /tmp/nix-install
mkdir -p /etc/nix
echo 'sandbox = false' > /etc/nix/nix.conf
echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf

yes y | deroot sh /tmp/nix-install --daemon

mkdir /content/.nix-defexpr /content/.cache /content/.config/nix -p
chown colab /content/.nix-defexpr /content/.cache /content/.config/nix -R
chown colab /nix -R

echo 'sandbox = false' >> /etc/nix/nix.conf
echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
echo 'trusted-users = colab root @wheel' >> /etc/nix/nix.conf

